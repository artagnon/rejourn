#!/usr/bin/env python
#-*- Mode:Python -*-
from __future__ import with_statement
import os
import util

"""Generate the Makefile"""

config = util.parse_config()
indir = config.get('indir')
outdir = config.get('outdir')
separator = config.get('separator', '---')
target = {}
tags = {}

for filename in os.listdir(indir):
    if filename.endswith('.txt'):
        # Find targets from the infile headers
        with open(os.path.join(indir, filename), 'r') as infh:
            raw_header = infh.read().split('\n' + separator + '\n', 1)[0]
            header = util.parse_header(raw_header)
            title = header.get('title', 'No Title')
            permalink = header.get('permalink', util.build_slug(config, title, filename))
            if not header.get('draft', None):
                target[filename] = os.path.join(outdir, permalink + '.html')
                if header.get('tags', None):
                    for tag in header.get('tags', None).split(', '):
                        if tag in tags.keys():
                            tags[tag].append(filename)
                        else:
                            tags[tag] = [filename]

# Write the Makefile
with open('Makefile', 'w') as makefh:
    makefh.write(".PHONY: default test clean\n")
    makefh.write("ifndef V\nQUIET_BUILD       = @echo '   ' BUILD $@;\nendif\n")
    # PHONY default: Build all targets
    makefh.write("default: "
                 + ' '.join(target.values()) + ' '
                 + os.path.join(outdir, 'archive.html') + ' '
                 + os.path.join(outdir, 'index.html') + ' '
                 + os.path.join(outdir, 'index.rss') + ' '
                 + ' '.join(map(lambda t: os.path.join(outdir, t + '.html'), tags.keys())) + ' '
                 + ' '.join(map(lambda t: os.path.join(outdir, t + '.rss'), tags.keys())) + '\n')

    # Write the various targets
    for filename in target.keys():
        makefh.write(target[filename] + ': '
                     + os.path.join(indir, filename) + '\n\t'
                     + '$(QUIET_BUILD)./build ' + filename[:-4] + '\n')

    # Special archive and index target
    makefh.write(outdir + '/archive.html: '
                 + ' '.join(map(lambda f: os.path.join(indir, f), target.keys()))
                 + '\n\t$(QUIET_BUILD)./build archive '
                 + ' '.join(map(lambda f: f[:-4], target.keys())) + '\n')
    makefh.write(outdir + '/index.html: '
                 + ' '.join(map(lambda f: os.path.join(indir, f), target.keys()))
                 + '\n\t$(QUIET_BUILD)./build index '
                 + ' '.join(map(lambda f: f[:-4], target.keys())) + '\n')
    makefh.write(outdir + '/index.rss: '
                 + ' '.join(map(lambda f: os.path.join(indir, f), target.keys()))
                 + '\n\t$(QUIET_BUILD)./build index.rss '
                 + ' '.join(map(lambda f: f[:-4], target.keys())) + '\n')

    # Tags
    for tag in tags:
        makefh.write(outdir + '/' + tag + '.html: '
                + ' '.join(map(lambda f: os.path.join(indir, f), tags[tag]))
                + '\n\t$(QUIET_BUILD)./build ' + tag + ' '
                + ' '.join(map(lambda f: f[:-4], tags[tag])) + '\n')
        makefh.write(outdir + '/' + tag + '.rss: '
                + ' '.join(map(lambda f: os.path.join(indir, f), tags[tag]))
                + '\n\t$(QUIET_BUILD)./build ' + tag + '.rss '
                + ' '.join(map(lambda f: f[:-4], tags[tag])) + '\n')

    # Phony test and clean targets
    makefh.write("test:\n\tnosetests\n")
    makefh.write("clean:\n\t$(RM) "
                 + os.path.join(outdir, "*.html") + " "
                 + os.path.join(outdir, "*.rss") + "\n")
    
        
# vim:set shiftwidth=4 softtabstop=4 expandtab:
